
### 创建文件块
```shell
dd if=/dev/zero of=./ext2.bin bs=1M count=100
mkfs.ext2 ext2.bin
sudo losetup /dev/loop39 ./ext2.bin 
sudo mount /dev/loop39 /tmp/ext2/
mkdir /tmp/ext2/
sudo mount /dev/loop39 /tmp/ext2/
```

### 跟踪函数调用

```shell
su
cd /sys/kernel/debug/tracing/
echo "function_graph" > current_tracer 
echo "xfs_*" > set_ftrace_filter
```

### 查看文件块信息

```shell
(base) lv@lv:ch4$ dumpe2fs ext2.bin 
dumpe2fs 1.44.1 (24-Mar-2018)
Filesystem volume name:   <none>
Last mounted on:          <not available>
Filesystem UUID:          db23d734-c23b-4f52-99e0-f73813086270
Filesystem magic number:  0xEF53
Filesystem revision #:    1 (dynamic)
Filesystem features:      ext_attr resize_inode dir_index filetype sparse_super large_file
Filesystem flags:         signed_directory_hash 
Default mount options:    user_xattr acl
Filesystem state:         not clean
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              25688
Block count:              102400
Reserved block count:     5120
Free blocks:              97600
Free inodes:              25677
First block:              1
Block size:               1024
Fragment size:            1024
Reserved GDT blocks:      256
Blocks per group:         8192
Fragments per group:      8192
Inodes per group:         1976
Inode blocks per group:   247
Filesystem created:       Sun Mar 13 11:52:02 2022
Last mount time:          Sun Mar 13 11:54:00 2022
Last write time:          Sun Mar 13 11:54:00 2022
Mount count:              1
Maximum mount count:      -1
Last checked:             Sun Mar 13 11:52:02 2022
Check interval:           0 (<none>)
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
First inode:              11
Inode size:	          128
Default directory hash:   half_md4
Directory Hash Seed:      55b73d4d-85a3-40f9-bd0b-7c1b462c9f8a


组 0：(块 1-8192)
  主 超级块位于 1，组描述符位于 2-2
  保留的GDT块位于 3-258
  块位图位于 259 (+258)
  Inode 位图位于 260 (+259)
  Inode表位于 261-507 (+260)
  7671 个可用 块，1965 个可用inode，2 个目录 
  可用块数： 522-8192
  可用inode数： 12-1976
组 1：(块 8193-16384)
  备份 超级块位于 8193，组描述符位于 8194-8194
  保留的GDT块位于 8195-8450
  块位图位于 8451 (+258)
  Inode 位图位于 8452 (+259)
  Inode表位于 8453-8699 (+260)
  7685 个可用 块，1976 个可用inode，0 个目录 
  可用块数： 8700-16384
  可用inode数： 1977-3952
组 2：(块 16385-24576)
  块位图位于 16385 (+0)
  Inode 位图位于 16386 (+1)
  Inode表位于 16387-16633 (+2)
  7943 个可用 块，1976 个可用inode，0 个目录 
  可用块数： 16634-24576
  可用inode数： 3953-5928
```

### 查看块组0，块组1
```shell
(base) lv@lv:ch4$ hexdump -n 1024 -s 2048 ext2.bin 
0000800 0103 0000 0104 0000 0105 0000 1df7 07ad
0000810 0002 0004 0000 0000 0000 0000 0000 0000
0000820 2103 0000 2104 0000 2105 0000 1e05 07b8
0000830 0000 0004 0000 0000 0000 0000 0000 0000
0000840 4001 0000 4002 0000 4003 0000 1f07 07b8
0000850 0000 0004 0000 0000 0000 0000 0000 0000
0000860 6103 0000 6104 0000 6105 0000 1e05 07b8
0000870 0000 0004 0000 0000 0000 0000 0000 0000
0000880 8001 0000 8002 0000 8003 0000 1f07 07b8
0000890 0000 0004 0000 0000 0000 0000 0000 0000
00008a0 a103 0000 a104 0000 a105 0000 1e05 07b8
00008b0 0000 0004 0000 0000 0000 0000 0000 0000
00008c0 c001 0000 c002 0000 c003 0000 1f07 07b8
00008d0 0000 0004 0000 0000 0000 0000 0000 0000
00008e0 e103 0000 e104 0000 e105 0000 1e05 07b8
00008f0 0000 0004 0000 0000 0000 0000 0000 0000
0000900 0001 0001 0002 0001 0003 0001 1f07 07b8
0000910 0000 0004 0000 0000 0000 0000 0000 0000
0000920 2103 0001 2104 0001 2105 0001 1e05 07b8
0000930 0000 0004 0000 0000 0000 0000 0000 0000
0000940 4001 0001 4002 0001 4003 0001 1f07 07b8
0000950 0000 0004 0000 0000 0000 0000 0000 0000
0000960 6001 0001 6002 0001 6003 0001 1f07 07b8
0000970 0000 0004 0000 0000 0000 0000 0000 0000
0000980 8001 0001 8002 0001 8003 0001 0f06 07b8
0000990 0000 0004 0000 0000 0000 0000 0000 0000
00009a0 0000 0000 0000 0000 0000 0000 0000 0000
*
0000c00
```

块位图偏移 259， 已使用逻辑块 16 * 4 * 8 + 9 = 521

```shell
(base) lv@lv:ch4$ hexdump -v -n 1024 -s 265216  ext2.bin 
0040c00 ffff ffff ffff ffff ffff ffff ffff ffff
0040c10 ffff ffff ffff ffff ffff ffff ffff ffff
0040c20 ffff ffff ffff ffff ffff ffff ffff ffff
0040c30 ffff ffff ffff ffff ffff ffff ffff ffff
0040c40 01ff 0000 0000 0000 0000 0000 0000 0000
0040c50 0000 0000 0000 0000 0000 0000 0000 0000
0040c60 0000 0000 0000 0000 0000 0000 0000 0000
0040c70 0000 0000 0000 0000 0000 0000 0000 0000
```

inode 位图偏移 260
```shell
(base) lv@lv:ch4$ hexdump -v -n 1024 -s 266240  ext2.bin 
0041000 ffff 0000 0000 0000 0000 0000 0000 0000
0041010 0000 0000 0000 0000 0000 0000 0000 0000
0041020 0000 0000 0000 0000 0000 0000 0000 0000
0041030 0000 0000 0000 0000 0000 0000 0000 0000
0041040 0000 0000 0000 0000 0000 0000 0000 0000
0041050 0000 0000 0000 0000 0000 0000 0000 0000
0041060 0000 0000 0000 0000 0000 0000 0000 0000
0041070 0000 0000 0000 0000 0000 0000 0000 0000
0041080 0000 0000 0000 0000 0000 0000 0000 0000
0041090 0000 0000 0000 0000 0000 0000 0000 0000
00410a0 0000 0000 0000 0000 0000 0000 0000 0000
00410b0 0000 0000 0000 0000 0000 0000 0000 0000
00410c0 0000 0000 0000 0000 0000 0000 0000 0000
00410d0 0000 0000 0000 0000 0000 0000 0000 0000
00410e0 0000 0000 0000 0000 0000 0000 0000 0000
00410f0 0000 0000 0000 ff00 ffff ffff ffff ffff
0041100 ffff ffff ffff ffff ffff ffff ffff ffff
```

### 第一列时inode ID

前 11 个为内部使用

2 表示根，目录

```shell
(base) lv@lv:ext2$ ls -alhi
总用量 129K
       2 drwxr-xr-x  3 lv   root 1.0K 3月  13 12:35 .
45481985 drwxrwxrwt 22 root root 112K 3月  13 12:42 ..
      12 -rw-rw-r--  1 lv   lv      0 3月  13 12:35 f1.txt
      13 -rw-rw-r--  1 lv   lv      0 3月  13 12:35 f2.txt
      14 -rw-rw-r--  1 lv   lv      0 3月  13 12:35 f3.txt
      15 -rw-rw-r--  1 lv   lv      0 3月  13 12:35 f4.txt
      16 -rw-rw-r--  1 lv   lv      0 3月  13 12:35 f5.txt
      11 drwx------  2 root root  12K 3月  13 11:52 lost+found

```

### 查看 inode 12 的数据
 inode 大小 126字节

 261 * 1024 + 11 * 128

 第12，13 inode

```shell
(base) lv@lv:ch4$ hexdump -v -n 256 -s 268672  ext2.bin 
0041980 81b4 03e8 0000 0000 7492 622d 7492 622d
0041990 7492 622d 0000 0000 03e8 0001 0000 0000
00419a0 0000 0000 0001 0000 0000 0000 0000 0000
00419b0 0000 0000 0000 0000 0000 0000 0000 0000
00419c0 0000 0000 0000 0000 0000 0000 0000 0000
00419d0 0000 0000 0000 0000 0000 0000 0000 0000
00419e0 0000 0000 1af2 0510 0000 0000 0000 0000
00419f0 0000 0000 0000 0000 0000 0000 0000 0000
0041a00 81b4 03e8 0000 0000 7494 622d 7494 622d
0041a10 7494 622d 0000 0000 03e8 0001 0000 0000
0041a20 0000 0000 0001 0000 0000 0000 0000 0000
0041a30 0000 0000 0000 0000 0000 0000 0000 0000
0041a40 0000 0000 0000 0000 0000 0000 0000 0000
0041a50 0000 0000 0000 0000 0000 0000 0000 0000
0041a60 0000 0000 3717 8565 0000 0000 0000 0000
0041a70 0000 0000 0000 0000 0000 0000 0000 0000
0041a80
```
其中 0x81b4

```shell
1000 0001 1011 0100
0100664
0100000 普通文件
rw-rw-r-- 读写权限
```
f1.txt  权限

``` shell
(base) lv@lv:ch4$ ll /tmp/ext2/
总用量 129
drwxr-xr-x  3 lv   root   1024 3月  13 12:35 ./
drwxrwxrwt 22 root root 114688 3月  13 14:13 ../
-rw-rw-r--  1 lv   lv        0 3月  13 12:35 f1.txt

```

### 获取 id 为2 的inode
inode 128 字节
```shell
(base) lv@lv:ch4$ hexdump -v -n 256 -s 267264  ext2.bin 
0041400 0000 0000 0000 0000 6a62 622d 6a62 622d
0041410 6a62 622d 0000 0000 0000 0000 0000 0000
0041420 0000 0000 0000 0000 0000 0000 0000 0000
0041430 0000 0000 0000 0000 0000 0000 0000 0000
0041440 0000 0000 0000 0000 0000 0000 0000 0000
0041450 0000 0000 0000 0000 0000 0000 0000 0000
0041460 0000 0000 0000 0000 0000 0000 0000 0000
0041470 0000 0000 0000 0000 0000 0000 0000 0000
-----  inode 2
0041480 41ed 03e8 0400 0000 74a0 622d 749f 622d
0041490 749f 622d 0000 0000 0000 0003 0002 0000
00414a0 0000 0000 0005 0000 01fc 0000 0000 0000
00414b0 0000 0000 0000 0000 0000 0000 0000 0000
00414c0 0000 0000 0000 0000 0000 0000 0000 0000
00414d0 0000 0000 0000 0000 0000 0000 0000 0000
00414e0 0000 0000 0000 0000 0000 0000 0000 0000
00414f0 0000 0000 0000 0000 0000 0000 0000 0000
0041500
```

# f1.txt
|inode id|     -| 目录项长度|类型|文件名长度|      -| 文件名|    -|      -|
|              -|       -|                      -|      -|                     -|     -|              -|    -|      -|
|000c    |0000 | 0010 | 01   | 06          | 3166 | 742e | 7448 |  0000|


```shell

(base) lv@lv:ch4$ hexdump -n 1024 -s 520192 ext2.bin  -v -C
0007f000  02 00 00 00 0c 00 01 02  2e 00 00 00 02 00 00 00  |................|
0007f010  0c 00 02 02 2e 2e 00 00  0b 00 00 00 14 00 0a 02  |................|
0007f020  6c 6f 73 74 2b 66 6f 75  6e 64 00 00 0c 00 00 00  |lost+found......|
0007f030  10 00 06 01 66 31 2e 74  78 74 00 00 0d 00 00 00  |....f1.txt......|
0007f040  10 00 06 01 66 32 2e 74  78 74 00 00 0e 00 00 00  |....f2.txt......|
0007f050  10 00 06 01 66 33 2e 74  78 74 00 00 0f 00 00 00  |....f3.txt......|
0007f060  10 00 06 01 66 34 2e 74  78 74 00 00 10 00 00 00  |....f4.txt......|
0007f070  94 03 06 01 66 35 2e 74  78 74 00 00 00 00 00 00  |....f5.txt......|

```
